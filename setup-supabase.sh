#!/bin/bash

# Script to help set up Supabase keys for Gmail Warmup Dashboard

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                â•‘"
echo "â•‘         ğŸ“§ Gmail Warmup - Supabase Setup Helper               â•‘"
echo "â•‘                                                                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "This app requires valid Supabase API keys to run."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”‘ STEP 1: Get Your Supabase Keys"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Open this URL in your browser:"
echo "   ğŸ‘‰ https://supabase.com/dashboard/project/dcxnduxjczwzsxtitgjx/settings/api"
echo ""
echo "2. Find 'Project API keys' section"
echo ""
echo "3. Copy the following keys:"
echo "   â€¢ anon / public key (starts with eyJhbGci...)"
echo "   â€¢ service_role key (optional, for admin operations)"
echo ""
read -p "Press ENTER when you have the keys ready..."

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš™ï¸  STEP 2: Enter Your Keys"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Paste your ANON KEY (anon/public): " ANON_KEY
echo ""
read -p "Paste your SERVICE ROLE KEY (optional, press ENTER to skip): " SERVICE_KEY

if [ -z "$ANON_KEY" ]; then
  echo "âŒ Error: ANON KEY is required!"
  exit 1
fi

# Set default service key if not provided
if [ -z "$SERVICE_KEY" ]; then
  SERVICE_KEY="PLACEHOLDER-SERVICE-KEY"
  echo "âš ï¸  Skipping service role key (some features may be limited)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¾ STEP 3: Updating .env File"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Backup existing .env
if [ -f .env ]; then
  cp .env .env.backup
  echo "âœ… Backed up existing .env to .env.backup"
fi

# Update .env with new keys
sed -i "s|NEXT_PUBLIC_SUPABASE_ANON_KEY=.*|NEXT_PUBLIC_SUPABASE_ANON_KEY=\"$ANON_KEY\"|g" .env
sed -i "s|SUPABASE_SERVICE_ROLE_KEY=.*|SUPABASE_SERVICE_ROLE_KEY=\"$SERVICE_KEY\"|g" .env

echo "âœ… Updated .env with your Supabase keys"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ§ª STEP 4: Testing Connection"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Test the connection
TEST_RESULT=$(curl -s "https://dcxnduxjczwzsxtitgjx.supabase.co/rest/v1/" \
  -H "apikey: $ANON_KEY" \
  -H "Authorization: Bearer $ANON_KEY" 2>&1)

if echo "$TEST_RESULT" | grep -q "Invalid"; then
  echo "âŒ Connection test failed!"
  echo "   Response: $TEST_RESULT"
  echo ""
  echo "   Please double-check your keys and try again."
  exit 1
else
  echo "âœ… Connection successful!"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ STEP 5: Setup Database"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Push database schema to Supabase? (y/n): " SETUP_DB

if [ "$SETUP_DB" = "y" ] || [ "$SETUP_DB" = "Y" ]; then
  echo "Generating Prisma client..."
  npx prisma generate
  
  echo "Pushing schema to Supabase..."
  npx prisma db push
  
  echo "âœ… Database setup complete!"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ Setup Complete!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Your Gmail Warmup Dashboard is now configured!"
echo ""
echo "ğŸš€ Start the server:"
echo "   npm run dev"
echo ""
echo "ğŸ“± Access at:"
echo "   http://localhost:3000"
echo ""
echo "You'll need to sign up with email/password on first visit."
echo ""
